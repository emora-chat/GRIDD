import sys, os
sys.path.append(os.getcwd())
import unittest
from GRIDD.data_structures.update_graph import UpdateGraph
from GRIDD.data_structures.concept_graph import ConceptGraph
from GRIDD.globals import *
import numpy as np
import random, time

from GRIDD.utilities.profiler import profiler as p

MY_DECAY = 0.1
def update_salienceold(wm):
    """
    wm: a ConceptGraph representing current working memory.
    """

    edges = []
    for e in wm.to_graph().edges():
        if e[0] not in SAL_FREE and e[1] not in SAL_FREE:
            if not wm.has(predicate_id=e[0]) or wm.type(e[0]) not in SAL_FREE:
                edges.append(e)
    redges = [(t, s, l) for s, t, l in edges]
    and_links = [edge for edge in wm.metagraph.edges() if isinstance(edge[2], tuple) and AND_LINK == edge[2][0]]
    for evidence, and_node, _ in and_links:
        or_links = [edge for edge in wm.metagraph.out_edges(and_node) if
                    isinstance(edge[2], tuple) and OR_LINK == edge[2][0]]
        for _, implication, _ in or_links:
            redges.append((evidence, implication, None))

    def moderated_salience(salience, connectivity):
        return salience / connectivity

    def update_instance_salience(val, args):
        in_ms = []
        out_ms = [val[0]]
        for (sal, con), lnk in args:
            if lnk == SALIENCE_IN_LINK:
                in_ms.append(moderated_salience(sal, con) - ASSOCIATION_DECAY)
            else:
                out_ms.append(sal)
        avg = sum(in_ms) / len(in_ms) if len(in_ms) > 0 else 0
        return (max(out_ms + [avg]), val[1])

    updater = UpdateGraph(
        [*[(s, t, SALIENCE_OUT_LINK) for s, t, _ in edges],
         *[(s, t, SALIENCE_IN_LINK) for s, t, _ in redges]],
        nodes={
            c: (wm.features.get(c, {}).get(SALIENCE, 0),
                wm.features.get(c, {}).get(CONNECTIVITY, 1))
            for c in wm.concepts()},
        updaters={c: update_instance_salience for c in wm.concepts()},
        default=(0, 1),
        set_fn=(lambda n, v: wm.features.setdefault(n, {}).__setitem__(SALIENCE, v[0]))
    )
    updater.update(1, push=True)
    sal = {}
    for i in wm.to_graph().nodes():
        try:
            sal[i] = wm.features[i][SALIENCE]
        except:
            sal[i] = 0
    return sal



def update_salience(wm):
    p.start('init')
    wmc = wm.concepts()
    npedges = np.zeros(shape=(len(wmc), len(wmc)))
    ewmc = list(enumerate(wmc))
    names = {name: i for i, name in ewmc}
    npsal = np.expand_dims(np.array([wm.features.get(name, {}).get(SALIENCE, 0.0) for i,name in ewmc]), 0)

    p.next('setup 1')
    for s, t, o, i in wm.predicates():
        if i not in SAL_FREE:
            if s not in SAL_FREE:
                npedges[names[s]][names[i]] = MY_DECAY
                npedges[names[i]][names[s]] = MY_DECAY
            if t not in SAL_FREE:
                npedges[names[t]][names[i]] = MY_DECAY
                npedges[names[i]][names[t]] = MY_DECAY
            if o is not None and o not in SAL_FREE:
                npedges[names[o]][names[i]] = MY_DECAY
                npedges[names[i]][names[o]] = MY_DECAY

    p.next('setup 2')
    for edge in wm.metagraph.edges():
        if isinstance(edge[2], tuple) and AND_LINK == edge[2][0]:
            for evidence, and_node, _ in edge:
                or_links = [edge for edge in wm.metagraph.out_edges(and_node) if
                            isinstance(edge[2], tuple) and OR_LINK == edge[2][0]]
                for _, implication, _ in or_links:
                    npedges[names[evidence]][names[implication]] = MY_DECAY

    p.next('calc')
    a = np.matmul(npsal, npedges)

    p.next('assign')
    for i, c in ewmc:
        if c in wm.features and SALIENCE in wm.features[c]:
            wm.features[c][SALIENCE] += min(wm.features[c][SALIENCE] + a[0][i],1.0)
        else:
            wm.features[c][SALIENCE] = min(a[0][i],1.0)
    p.stop()
    p.report()

class TestSalienceUpdate(unittest.TestCase):

    def test_update_salience(self):
        a = '''
        
        dog = (entity)
        cat = (entity)
        chase = (predicate)
        happy = (predicate)
        ;
        
        a = dog()
        b = dog()
        c = cat()
        d = dog()
        e = cat()
        f = dog()
        g = dog()
        h = cat()
        i = cat()
        a0 = dog() 
        a1 = dog() 
        a2 = dog() 
        a3 = dog() 
        a4 = dog() 
        a5 = dog() 
        a6 = dog() 
        a7 = dog() 
        a8 = dog() 
        a9 = dog() 
        a10 = dog() 
        a11 = dog() 
        a12 = dog() 
        a13 = dog() 
        a14 = dog() 
        a15 = dog() 
        a16 = dog() 
        a17 = dog() 
        a18 = dog() 
        a19 = dog() 
        a20 = dog() 
        a21 = dog() 
        a22 = dog() 
        a23 = dog() 
        a24 = dog() 
        a25 = dog() 
        a26 = dog() 
        a27 = dog() 
        a28 = dog() 
        a29 = dog() 
        a30 = dog() 
        a31 = dog() 
        a32 = dog() 
        a33 = dog() 
        a34 = dog() 
        a35 = dog() 
        a36 = dog() 
        a37 = dog() 
        a38 = dog() 
        a39 = dog() 
        a40 = dog() 
        a41 = dog() 
        a42 = dog() 
        a43 = dog() 
        a44 = dog() 
        a45 = dog() 
        a46 = dog() 
        a47 = dog() 
        a48 = dog() 
        a49 = dog() 
        a50 = dog() 
        a51 = dog() 
        a52 = dog() 
        a53 = dog() 
        a54 = dog() 
        a55 = dog() 
        a56 = dog() 
        a57 = dog() 
        a58 = dog() 
        a59 = dog() 
        a60 = dog() 
        a61 = dog() 
        a62 = dog() 
        a63 = dog() 
        a64 = dog() 
        a65 = dog() 
        a66 = dog() 
        a67 = dog() 
        a68 = dog() 
        a69 = dog() 
        a70 = dog() 
        a71 = dog() 
        a72 = dog() 
        a73 = dog() 
        a74 = dog() 
        a75 = dog() 
        a76 = dog() 
        a77 = dog() 
        a78 = dog() 
        a79 = dog() 
        a80 = dog() 
        a81 = dog() 
        a82 = dog() 
        a83 = dog() 
        a84 = dog() 
        a85 = dog() 
        a86 = dog() 
        a87 = dog() 
        a88 = dog() 
        a89 = dog() 
        a90 = dog() 
        a91 = dog() 
        a92 = dog() 
        a93 = dog() 
        a94 = dog() 
        a95 = dog() 
        a96 = dog() 
        a97 = dog() 
        a98 = dog() 
        a99 = dog() 
        a100 = dog() 
        a101 = dog() 
        a102 = dog() 
        a103 = dog() 
        a104 = dog() 
        a105 = dog() 
        a106 = dog() 
        a107 = dog() 
        a108 = dog() 
        a109 = dog() 
        a110 = dog() 
        a111 = dog() 
        a112 = dog() 
        a113 = dog() 
        a114 = dog() 
        a115 = dog() 
        a116 = dog() 
        a117 = dog() 
        a118 = dog() 
        a119 = dog() 
        a120 = dog() 
        a121 = dog() 
        a122 = dog() 
        a123 = dog() 
        a124 = dog() 
        a125 = dog() 
        a126 = dog() 
        a127 = dog() 
        a128 = dog() 
        a129 = dog() 
        a130 = dog() 
        a131 = dog() 
        a132 = dog() 
        a133 = dog() 
        a134 = dog() 
        a135 = dog() 
        a136 = dog() 
        a137 = dog() 
        a138 = dog() 
        a139 = dog() 
        a140 = dog() 
        a141 = dog() 
        a142 = dog() 
        a143 = dog() 
        a144 = dog() 
        a145 = dog() 
        a146 = dog() 
        a147 = dog() 
        a148 = dog() 
        a149 = dog() 
        a150 = dog() 
        a151 = dog() 
        a152 = dog() 
        a153 = dog() 
        a154 = dog() 
        a155 = dog() 
        a156 = dog() 
        a157 = dog() 
        a158 = dog() 
        a159 = dog() 
        a160 = dog() 
        a161 = dog() 
        a162 = dog() 
        a163 = dog() 
        a164 = dog() 
        a165 = dog() 
        a166 = dog() 
        a167 = dog() 
        a168 = dog() 
        a169 = dog() 
        a170 = dog() 
        a171 = dog() 
        a172 = dog() 
        a173 = dog() 
        a174 = dog() 
        a175 = dog() 
        a176 = dog() 
        a177 = dog() 
        a178 = dog() 
        a179 = dog() 
        a180 = dog() 
        a181 = dog() 
        a182 = dog() 
        a183 = dog() 
        a184 = dog() 
        a185 = dog() 
        a186 = dog() 
        a187 = dog() 
        a188 = dog() 
        a189 = dog() 
        a190 = dog() 
        a191 = dog() 
        a192 = dog() 
        a193 = dog() 
        a194 = dog() 
        a195 = dog() 
        a196 = dog() 
        a197 = dog() 
        a198 = dog() 
        a199 = dog() 
        a200 = dog() 
        a201 = dog() 
        a202 = dog() 
        a203 = dog() 
        a204 = dog() 
        a205 = dog() 
        a206 = dog() 
        a207 = dog() 
        a208 = dog() 
        a209 = dog() 
        a210 = dog() 
        a211 = dog() 
        a212 = dog() 
        a213 = dog() 
        a214 = dog() 
        a215 = dog() 
        a216 = dog() 
        a217 = dog() 
        a218 = dog() 
        a219 = dog() 
        a220 = dog() 
        a221 = dog() 
        a222 = dog() 
        a223 = dog() 
        a224 = dog() 
        a225 = dog() 
        a226 = dog() 
        a227 = dog() 
        a228 = dog() 
        a229 = dog() 
        a230 = dog() 
        a231 = dog() 
        a232 = dog() 
        a233 = dog() 
        a234 = dog() 
        a235 = dog() 
        a236 = dog() 
        a237 = dog() 
        a238 = dog() 
        a239 = dog() 
        a240 = dog() 
        a241 = dog() 
        a242 = dog() 
        a243 = dog() 
        a244 = dog() 
        a245 = dog() 
        a246 = dog() 
        a247 = dog() 
        a248 = dog() 
        a249 = dog() 
        a250 = dog() 
        a251 = dog() 
        a252 = dog() 
        a253 = dog() 
        a254 = dog() 
        a255 = dog() 
        a256 = dog() 
        a257 = dog() 
        a258 = dog() 
        a259 = dog() 
        a260 = dog() 
        a261 = dog() 
        a262 = dog() 
        a263 = dog() 
        a264 = dog() 
        a265 = dog() 
        a266 = dog() 
        a267 = dog() 
        a268 = dog() 
        a269 = dog() 
        a270 = dog() 
        a271 = dog() 
        a272 = dog() 
        a273 = dog() 
        a274 = dog() 
        a275 = dog() 
        a276 = dog() 
        a277 = dog() 
        a278 = dog() 
        a279 = dog() 
        a280 = dog() 
        a281 = dog() 
        a282 = dog() 
        a283 = dog() 
        a284 = dog() 
        a285 = dog() 
        a286 = dog() 
        a287 = dog() 
        a288 = dog() 
        a289 = dog() 
        a290 = dog() 
        a291 = dog() 
        a292 = dog() 
        a293 = dog() 
        a294 = dog() 
        a295 = dog() 
        a296 = dog() 
        a297 = dog() 
        a298 = dog() 
        a299 = dog() 
        a300 = dog() 
        a301 = dog() 
        a302 = dog() 
        a303 = dog() 
        a304 = dog() 
        a305 = dog() 
        a306 = dog() 
        a307 = dog() 
        a308 = dog() 
        a309 = dog() 
        a310 = dog() 
        a311 = dog() 
        a312 = dog() 
        a313 = dog() 
        a314 = dog() 
        a315 = dog() 
        a316 = dog() 
        a317 = dog() 
        a318 = dog() 
        a319 = dog() 
        a320 = dog() 
        a321 = dog() 
        a322 = dog() 
        a323 = dog() 
        a324 = dog() 
        a325 = dog() 
        a326 = dog() 
        a327 = dog() 
        a328 = dog() 
        a329 = dog() 
        a330 = dog() 
        a331 = dog() 
        a332 = dog() 
        a333 = dog() 
        a334 = dog() 
        a335 = dog() 
        a336 = dog() 
        a337 = dog() 
        a338 = dog() 
        a339 = dog() 
        a340 = dog() 
        a341 = dog() 
        a342 = dog() 
        a343 = dog() 
        a344 = dog() 
        a345 = dog() 
        a346 = dog() 
        a347 = dog() 
        a348 = dog() 
        a349 = dog() 
        a350 = dog() 
        a351 = dog() 
        a352 = dog() 
        a353 = dog() 
        a354 = dog() 
        a355 = dog() 
        a356 = dog() 
        a357 = dog() 
        a358 = dog() 
        a359 = dog() 
        a360 = dog() 
        a361 = dog() 
        a362 = dog() 
        a363 = dog() 
        a364 = dog() 
        a365 = dog() 
        a366 = dog() 
        a367 = dog() 
        a368 = dog() 
        a369 = dog() 
        a370 = dog() 
        a371 = dog() 
        a372 = dog() 
        a373 = dog() 
        a374 = dog() 
        a375 = dog() 
        a376 = dog() 
        a377 = dog() 
        a378 = dog() 
        a379 = dog() 
        a380 = dog() 
        a381 = dog() 
        a382 = dog() 
        a383 = dog() 
        a384 = dog() 
        a385 = dog() 
        a386 = dog() 
        a387 = dog() 
        a388 = dog() 
        a389 = dog() 
        a390 = dog() 
        a391 = dog() 
        a392 = dog() 
        a393 = dog() 
        a394 = dog() 
        a395 = dog() 
        a396 = dog() 
        a397 = dog() 
        a398 = dog() 
        a399 = dog() 
        
        ;
        
        cab=chase(a, b)
        cbc=chase(b, c)
        ccd=chase(c, d)
        cde=chase(d, e)
        cef=chase(e, f)
        cfg=chase(f, g)
        cgh=chase(g, h)
        cgi=chase(g, i)
        ca0a1 = chase(a0,a1) 
        ca1a2 = chase(a1,a2) 
        ca2a3 = chase(a2,a3) 
        ca3a4 = chase(a3,a4) 
        ca4a5 = chase(a4,a5) 
        ca5a6 = chase(a5,a6) 
        ca6a7 = chase(a6,a7) 
        ca7a8 = chase(a7,a8) 
        ca8a9 = chase(a8,a9) 
        ca9a10 = chase(a9,a10) 
        ca10a11 = chase(a10,a11) 
        ca11a12 = chase(a11,a12) 
        ca12a13 = chase(a12,a13) 
        ca13a14 = chase(a13,a14) 
        ca14a15 = chase(a14,a15) 
        ca15a16 = chase(a15,a16) 
        ca16a17 = chase(a16,a17) 
        ca17a18 = chase(a17,a18) 
        ca18a19 = chase(a18,a19) 
        ca19a20 = chase(a19,a20) 
        ca20a21 = chase(a20,a21) 
        ca21a22 = chase(a21,a22) 
        ca22a23 = chase(a22,a23) 
        ca23a24 = chase(a23,a24) 
        ca24a25 = chase(a24,a25) 
        ca25a26 = chase(a25,a26) 
        ca26a27 = chase(a26,a27) 
        ca27a28 = chase(a27,a28) 
        ca28a29 = chase(a28,a29) 
        ca29a30 = chase(a29,a30) 
        ca30a31 = chase(a30,a31) 
        ca31a32 = chase(a31,a32) 
        ca32a33 = chase(a32,a33) 
        ca33a34 = chase(a33,a34) 
        ca34a35 = chase(a34,a35) 
        ca35a36 = chase(a35,a36) 
        ca36a37 = chase(a36,a37) 
        ca37a38 = chase(a37,a38) 
        ca38a39 = chase(a38,a39) 
        ca39a40 = chase(a39,a40) 
        ca40a41 = chase(a40,a41) 
        ca41a42 = chase(a41,a42) 
        ca42a43 = chase(a42,a43) 
        ca43a44 = chase(a43,a44) 
        ca44a45 = chase(a44,a45) 
        ca45a46 = chase(a45,a46) 
        ca46a47 = chase(a46,a47) 
        ca47a48 = chase(a47,a48) 
        ca48a49 = chase(a48,a49) 
        ca49a50 = chase(a49,a50) 
        ca50a51 = chase(a50,a51) 
        ca51a52 = chase(a51,a52) 
        ca52a53 = chase(a52,a53) 
        ca53a54 = chase(a53,a54) 
        ca54a55 = chase(a54,a55) 
        ca55a56 = chase(a55,a56) 
        ca56a57 = chase(a56,a57) 
        ca57a58 = chase(a57,a58) 
        ca58a59 = chase(a58,a59) 
        ca59a60 = chase(a59,a60) 
        ca60a61 = chase(a60,a61) 
        ca61a62 = chase(a61,a62) 
        ca62a63 = chase(a62,a63) 
        ca63a64 = chase(a63,a64) 
        ca64a65 = chase(a64,a65) 
        ca65a66 = chase(a65,a66) 
        ca66a67 = chase(a66,a67) 
        ca67a68 = chase(a67,a68) 
        ca68a69 = chase(a68,a69) 
        ca69a70 = chase(a69,a70) 
        ca70a71 = chase(a70,a71) 
        ca71a72 = chase(a71,a72) 
        ca72a73 = chase(a72,a73) 
        ca73a74 = chase(a73,a74) 
        ca74a75 = chase(a74,a75) 
        ca75a76 = chase(a75,a76) 
        ca76a77 = chase(a76,a77) 
        ca77a78 = chase(a77,a78) 
        ca78a79 = chase(a78,a79) 
        ca79a80 = chase(a79,a80) 
        ca80a81 = chase(a80,a81) 
        ca81a82 = chase(a81,a82) 
        ca82a83 = chase(a82,a83) 
        ca83a84 = chase(a83,a84) 
        ca84a85 = chase(a84,a85) 
        ca85a86 = chase(a85,a86) 
        ca86a87 = chase(a86,a87) 
        ca87a88 = chase(a87,a88) 
        ca88a89 = chase(a88,a89) 
        ca89a90 = chase(a89,a90) 
        ca90a91 = chase(a90,a91) 
        ca91a92 = chase(a91,a92) 
        ca92a93 = chase(a92,a93) 
        ca93a94 = chase(a93,a94) 
        ca94a95 = chase(a94,a95) 
        ca95a96 = chase(a95,a96) 
        ca96a97 = chase(a96,a97) 
        ca97a98 = chase(a97,a98) 
        ca98a99 = chase(a98,a99) 
        ca99a100 = chase(a99,a100) 
        ca100a101 = chase(a100,a101) 
        ca101a102 = chase(a101,a102) 
        ca102a103 = chase(a102,a103) 
        ca103a104 = chase(a103,a104) 
        ca104a105 = chase(a104,a105) 
        ca105a106 = chase(a105,a106) 
        ca106a107 = chase(a106,a107) 
        ca107a108 = chase(a107,a108) 
        ca108a109 = chase(a108,a109) 
        ca109a110 = chase(a109,a110) 
        ca110a111 = chase(a110,a111) 
        ca111a112 = chase(a111,a112) 
        ca112a113 = chase(a112,a113) 
        ca113a114 = chase(a113,a114) 
        ca114a115 = chase(a114,a115) 
        ca115a116 = chase(a115,a116) 
        ca116a117 = chase(a116,a117) 
        ca117a118 = chase(a117,a118) 
        ca118a119 = chase(a118,a119) 
        ca119a120 = chase(a119,a120) 
        ca120a121 = chase(a120,a121) 
        ca121a122 = chase(a121,a122) 
        ca122a123 = chase(a122,a123) 
        ca123a124 = chase(a123,a124) 
        ca124a125 = chase(a124,a125) 
        ca125a126 = chase(a125,a126) 
        ca126a127 = chase(a126,a127) 
        ca127a128 = chase(a127,a128) 
        ca128a129 = chase(a128,a129) 
        ca129a130 = chase(a129,a130) 
        ca130a131 = chase(a130,a131) 
        ca131a132 = chase(a131,a132) 
        ca132a133 = chase(a132,a133) 
        ca133a134 = chase(a133,a134) 
        ca134a135 = chase(a134,a135) 
        ca135a136 = chase(a135,a136) 
        ca136a137 = chase(a136,a137) 
        ca137a138 = chase(a137,a138) 
        ca138a139 = chase(a138,a139) 
        ca139a140 = chase(a139,a140) 
        ca140a141 = chase(a140,a141) 
        ca141a142 = chase(a141,a142) 
        ca142a143 = chase(a142,a143) 
        ca143a144 = chase(a143,a144) 
        ca144a145 = chase(a144,a145) 
        ca145a146 = chase(a145,a146) 
        ca146a147 = chase(a146,a147) 
        ca147a148 = chase(a147,a148) 
        ca148a149 = chase(a148,a149) 
        ca149a150 = chase(a149,a150) 
        ca150a151 = chase(a150,a151) 
        ca151a152 = chase(a151,a152) 
        ca152a153 = chase(a152,a153) 
        ca153a154 = chase(a153,a154) 
        ca154a155 = chase(a154,a155) 
        ca155a156 = chase(a155,a156) 
        ca156a157 = chase(a156,a157) 
        ca157a158 = chase(a157,a158) 
        ca158a159 = chase(a158,a159) 
        ca159a160 = chase(a159,a160) 
        ca160a161 = chase(a160,a161) 
        ca161a162 = chase(a161,a162) 
        ca162a163 = chase(a162,a163) 
        ca163a164 = chase(a163,a164) 
        ca164a165 = chase(a164,a165) 
        ca165a166 = chase(a165,a166) 
        ca166a167 = chase(a166,a167) 
        ca167a168 = chase(a167,a168) 
        ca168a169 = chase(a168,a169) 
        ca169a170 = chase(a169,a170) 
        ca170a171 = chase(a170,a171) 
        ca171a172 = chase(a171,a172) 
        ca172a173 = chase(a172,a173) 
        ca173a174 = chase(a173,a174) 
        ca174a175 = chase(a174,a175) 
        ca175a176 = chase(a175,a176) 
        ca176a177 = chase(a176,a177) 
        ca177a178 = chase(a177,a178) 
        ca178a179 = chase(a178,a179) 
        ca179a180 = chase(a179,a180) 
        ca180a181 = chase(a180,a181) 
        ca181a182 = chase(a181,a182) 
        ca182a183 = chase(a182,a183) 
        ca183a184 = chase(a183,a184) 
        ca184a185 = chase(a184,a185) 
        ca185a186 = chase(a185,a186) 
        ca186a187 = chase(a186,a187) 
        ca187a188 = chase(a187,a188) 
        ca188a189 = chase(a188,a189) 
        ca189a190 = chase(a189,a190) 
        ca190a191 = chase(a190,a191) 
        ca191a192 = chase(a191,a192) 
        ca192a193 = chase(a192,a193) 
        ca193a194 = chase(a193,a194) 
        ca194a195 = chase(a194,a195) 
        ca195a196 = chase(a195,a196) 
        ca196a197 = chase(a196,a197) 
        ca197a198 = chase(a197,a198) 
        ca198a199 = chase(a198,a199) 
        ca199a200 = chase(a199,a200) 
        ca200a201 = chase(a200,a201) 
        ca201a202 = chase(a201,a202) 
        ca202a203 = chase(a202,a203) 
        ca203a204 = chase(a203,a204) 
        ca204a205 = chase(a204,a205) 
        ca205a206 = chase(a205,a206) 
        ca206a207 = chase(a206,a207) 
        ca207a208 = chase(a207,a208) 
        ca208a209 = chase(a208,a209) 
        ca209a210 = chase(a209,a210) 
        ca210a211 = chase(a210,a211) 
        ca211a212 = chase(a211,a212) 
        ca212a213 = chase(a212,a213) 
        ca213a214 = chase(a213,a214) 
        ca214a215 = chase(a214,a215) 
        ca215a216 = chase(a215,a216) 
        ca216a217 = chase(a216,a217) 
        ca217a218 = chase(a217,a218) 
        ca218a219 = chase(a218,a219) 
        ca219a220 = chase(a219,a220) 
        ca220a221 = chase(a220,a221) 
        ca221a222 = chase(a221,a222) 
        ca222a223 = chase(a222,a223) 
        ca223a224 = chase(a223,a224) 
        ca224a225 = chase(a224,a225) 
        ca225a226 = chase(a225,a226) 
        ca226a227 = chase(a226,a227) 
        ca227a228 = chase(a227,a228) 
        ca228a229 = chase(a228,a229) 
        ca229a230 = chase(a229,a230) 
        ca230a231 = chase(a230,a231) 
        ca231a232 = chase(a231,a232) 
        ca232a233 = chase(a232,a233) 
        ca233a234 = chase(a233,a234) 
        ca234a235 = chase(a234,a235) 
        ca235a236 = chase(a235,a236) 
        ca236a237 = chase(a236,a237) 
        ca237a238 = chase(a237,a238) 
        ca238a239 = chase(a238,a239) 
        ca239a240 = chase(a239,a240) 
        ca240a241 = chase(a240,a241) 
        ca241a242 = chase(a241,a242) 
        ca242a243 = chase(a242,a243) 
        ca243a244 = chase(a243,a244) 
        ca244a245 = chase(a244,a245) 
        ca245a246 = chase(a245,a246) 
        ca246a247 = chase(a246,a247) 
        ca247a248 = chase(a247,a248) 
        ca248a249 = chase(a248,a249) 
        ca249a250 = chase(a249,a250) 
        ca250a251 = chase(a250,a251) 
        ca251a252 = chase(a251,a252) 
        ca252a253 = chase(a252,a253) 
        ca253a254 = chase(a253,a254) 
        ca254a255 = chase(a254,a255) 
        ca255a256 = chase(a255,a256) 
        ca256a257 = chase(a256,a257) 
        ca257a258 = chase(a257,a258) 
        ca258a259 = chase(a258,a259) 
        ca259a260 = chase(a259,a260) 
        ca260a261 = chase(a260,a261) 
        ca261a262 = chase(a261,a262) 
        ca262a263 = chase(a262,a263) 
        ca263a264 = chase(a263,a264) 
        ca264a265 = chase(a264,a265) 
        ca265a266 = chase(a265,a266) 
        ca266a267 = chase(a266,a267) 
        ca267a268 = chase(a267,a268) 
        ca268a269 = chase(a268,a269) 
        ca269a270 = chase(a269,a270) 
        ca270a271 = chase(a270,a271) 
        ca271a272 = chase(a271,a272) 
        ca272a273 = chase(a272,a273) 
        ca273a274 = chase(a273,a274) 
        ca274a275 = chase(a274,a275) 
        ca275a276 = chase(a275,a276) 
        ca276a277 = chase(a276,a277) 
        ca277a278 = chase(a277,a278) 
        ca278a279 = chase(a278,a279) 
        ca279a280 = chase(a279,a280) 
        ca280a281 = chase(a280,a281) 
        ca281a282 = chase(a281,a282) 
        ca282a283 = chase(a282,a283) 
        ca283a284 = chase(a283,a284) 
        ca284a285 = chase(a284,a285) 
        ca285a286 = chase(a285,a286) 
        ca286a287 = chase(a286,a287) 
        ca287a288 = chase(a287,a288) 
        ca288a289 = chase(a288,a289) 
        ca289a290 = chase(a289,a290) 
        ca290a291 = chase(a290,a291) 
        ca291a292 = chase(a291,a292) 
        ca292a293 = chase(a292,a293) 
        ca293a294 = chase(a293,a294) 
        ca294a295 = chase(a294,a295) 
        ca295a296 = chase(a295,a296) 
        ca296a297 = chase(a296,a297) 
        ca297a298 = chase(a297,a298) 
        ca298a299 = chase(a298,a299) 
        ca299a300 = chase(a299,a300) 
        ca300a301 = chase(a300,a301) 
        ca301a302 = chase(a301,a302) 
        ca302a303 = chase(a302,a303) 
        ca303a304 = chase(a303,a304) 
        ca304a305 = chase(a304,a305) 
        ca305a306 = chase(a305,a306) 
        ca306a307 = chase(a306,a307) 
        ca307a308 = chase(a307,a308) 
        ca308a309 = chase(a308,a309) 
        ca309a310 = chase(a309,a310) 
        ca310a311 = chase(a310,a311) 
        ca311a312 = chase(a311,a312) 
        ca312a313 = chase(a312,a313) 
        ca313a314 = chase(a313,a314) 
        ca314a315 = chase(a314,a315) 
        ca315a316 = chase(a315,a316) 
        ca316a317 = chase(a316,a317) 
        ca317a318 = chase(a317,a318) 
        ca318a319 = chase(a318,a319) 
        ca319a320 = chase(a319,a320) 
        ca320a321 = chase(a320,a321) 
        ca321a322 = chase(a321,a322) 
        ca322a323 = chase(a322,a323) 
        ca323a324 = chase(a323,a324) 
        ca324a325 = chase(a324,a325) 
        ca325a326 = chase(a325,a326) 
        ca326a327 = chase(a326,a327) 
        ca327a328 = chase(a327,a328) 
        ca328a329 = chase(a328,a329) 
        ca329a330 = chase(a329,a330) 
        ca330a331 = chase(a330,a331) 
        ca331a332 = chase(a331,a332) 
        ca332a333 = chase(a332,a333) 
        ca333a334 = chase(a333,a334) 
        ca334a335 = chase(a334,a335) 
        ca335a336 = chase(a335,a336) 
        ca336a337 = chase(a336,a337) 
        ca337a338 = chase(a337,a338) 
        ca338a339 = chase(a338,a339) 
        ca339a340 = chase(a339,a340) 
        ca340a341 = chase(a340,a341) 
        ca341a342 = chase(a341,a342) 
        ca342a343 = chase(a342,a343) 
        ca343a344 = chase(a343,a344) 
        ca344a345 = chase(a344,a345) 
        ca345a346 = chase(a345,a346) 
        ca346a347 = chase(a346,a347) 
        ca347a348 = chase(a347,a348) 
        ca348a349 = chase(a348,a349) 
        ca349a350 = chase(a349,a350) 
        ca350a351 = chase(a350,a351) 
        ca351a352 = chase(a351,a352) 
        ca352a353 = chase(a352,a353) 
        ca353a354 = chase(a353,a354) 
        ca354a355 = chase(a354,a355) 
        ca355a356 = chase(a355,a356) 
        ca356a357 = chase(a356,a357) 
        ca357a358 = chase(a357,a358) 
        ca358a359 = chase(a358,a359) 
        ca359a360 = chase(a359,a360) 
        ca360a361 = chase(a360,a361) 
        ca361a362 = chase(a361,a362) 
        ca362a363 = chase(a362,a363) 
        ca363a364 = chase(a363,a364) 
        ca364a365 = chase(a364,a365) 
        ca365a366 = chase(a365,a366) 
        ca366a367 = chase(a366,a367) 
        ca367a368 = chase(a367,a368) 
        ca368a369 = chase(a368,a369) 
        ca369a370 = chase(a369,a370) 
        ca370a371 = chase(a370,a371) 
        ca371a372 = chase(a371,a372) 
        ca372a373 = chase(a372,a373) 
        ca373a374 = chase(a373,a374) 
        ca374a375 = chase(a374,a375) 
        ca375a376 = chase(a375,a376) 
        ca376a377 = chase(a376,a377) 
        ca377a378 = chase(a377,a378) 
        ca378a379 = chase(a378,a379) 
        ca379a380 = chase(a379,a380) 
        ca380a381 = chase(a380,a381) 
        ca381a382 = chase(a381,a382) 
        ca382a383 = chase(a382,a383) 
        ca383a384 = chase(a383,a384) 
        ca384a385 = chase(a384,a385) 
        ca385a386 = chase(a385,a386) 
        ca386a387 = chase(a386,a387) 
        ca387a388 = chase(a387,a388) 
        ca388a389 = chase(a388,a389) 
        ca389a390 = chase(a389,a390) 
        ca390a391 = chase(a390,a391) 
        ca391a392 = chase(a391,a392) 
        ca392a393 = chase(a392,a393) 
        ca393a394 = chase(a393,a394) 
        ca394a395 = chase(a394,a395) 
        ca395a396 = chase(a395,a396) 
        ca396a397 = chase(a396,a397) 
        ca397a398 = chase(a397,a398) 
        ca398a399 = chase(a398,a399) 
        ;
        
        '''

        p.start()
        p.stop()

        meta = {'d': {SALIENCE: 1.0},}
        for i in range(399):
            meta['a'+str(i)] = {SALIENCE: random.random()}
        wm = ConceptGraph(a, metadata=meta,)
        print(f'Nodes: {len(wm.concepts())}, Edges: {len(list(wm.predicates()))}')

        # Here's how to access concept salience
        assert wm.features['d'][SALIENCE] == 1.0
        import time
        t1 = time.time()
        saliencesold = update_salienceold(wm)
        t2 = time.time()
        print("\nOld method: {}".format(t2 - t1))
        wm = ConceptGraph(a, metadata=meta,)

        # Here's how to access concept salience
        assert wm.features['d'][SALIENCE] == 1.0
        t21 = time.time()
        saliencesnew = update_salience(wm)
        t22 = time.time()
        print("My method: {}".format(t22 - t21))
        #  for concept, salience in saliences.items():
        #   print(concept, ':', salience)
        #for concept, salience in saliences.items():
        #    print(concept, ':', salience)
        '''
        Considerations:
        
        * Salience is supposed to model how an intelligent agent's attention
          shifts between concepts based on their semantic relatedness. There
          may be a few formulas for this; we basically just want the salience
          to "pool" onto concepts that are related to most of the existing 
          mentioned concepts. Feel free to change the salience update formula
          if you feel like the salience should be updated differently to get
          the right behavior.
        
        * Efficiency matters here. We want to update the salience of about
          200-400 concepts in under 0.1s if possible.        
          Best practices for efficient code:
            1) make sure time complexity of your algorithm makes sense
            2) don't bother with ANY micro-optimizations (optimizations
               that fall within the same big-O) until you run a profiler
               (cProfile is really good).
            3) Python is slow, especially when using lots of function calls
               within loops. If you do get to micro-optmizing, and are confident
               your alogrithm doesn't repeat any work, try refactoring to use 
               more built-in functions (e.g. python set operations) or libraries
               implemented in C such as numpy.
        '''

    def test_update_salience2(self):
        wm = ConceptGraph('''

        dog = (entity)
        cat = (entity)
        chase = (predicate)
        happy = (predicate)
        ;

        a = dog()
        b = dog()
        c = cat()
        d = dog()
        e = cat()
        f = dog()
        g = dog()
        h = cat()
        i = cat()
        ;

        cab=chase(a, b)
        cbc=chase(b, c)
        ccd=chase(c, d)
        cde=chase(d, e)
        cef=chase(e, f)
        cfg=chase(f, g)
        cgh=chase(g, h)
        cgi=chase(g, i)
        ;

        ''', metadata={
            'd': {SALIENCE: 1.0}
        })

        # Here's how to access concept salience
        # assert wm.features['d'][SALIENCE] == 1.0
        # for i in range(5):
        #     saliences = update_salience(wm)

        # for concept, salience in saliences.items():
        #     print(concept, ':', salience)
        # print()
        '''
        Considerations:

        * Salience is supposed to model how an intelligent agent's attention
          shifts between concepts based on their semantic relatedness. There
          may be a few formulas for this; we basically just want the salience
          to "pool" onto concepts that are related to most of the existing 
          mentioned concepts. Feel free to change the salience update formula
          if you feel like the salience should be updated differently to get
          the right behavior.

        * Efficiency matters here. We want to update the salience of about
          200-400 concepts in under 0.1s if possible.        
          Best practices for efficient code:
            1) make sure time complexity of your algorithm makes sense
            2) don't bother with ANY micro-optimizations (optimizations
               that fall within the same big-O) until you run a profiler
               (cProfile is really good).
            3) Python is slow, especially when using lots of function calls
               within loops. If you do get to micro-optmizing, and are confident
               your alogrithm doesn't repeat any work, try refactoring to use 
               more built-in functions (e.g. python set operations) or libraries
               implemented in C such as numpy.
        '''



if __name__ == '__main__':
    unittest.main()


